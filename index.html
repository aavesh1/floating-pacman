<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Floating Pacman</title>
    <script type="text/javascript">
      function draw() {
        let canvas = document.getElementById('game');
        canvas.width = document.body.clientWidth;
        canvas.height = document.body.clientHeight;
        if (!canvas.getContext) {
          console.log('Canvas not supported!');
          return;
        }
        let ctx = canvas.getContext('2d', { alpha: false });

        class Coordinate {
          constructor(x, y) {
            this.x = x;
            this.y = y;
          }
        }

        class Semicircle {
          constructor(rad, mouth, clockwise) {
            this.rad = rad;
            this.mouth = mouth;
            this.clockwise = clockwise;
          }
          render() {
            ctx.beginPath();
            ctx.arc(
              0,
              0,
              this.rad,
              this.mouth,
              this.mouth + Math.PI,
              this.clockwise
            );
            ctx.fillStyle = 'rgb(255, 255, 0)';
            ctx.fill();
          }
        }

        class Pacman {
          constructor(
            x,
            y,
            rad,
            mouth,
            speed,
            face = 0,
            ux = 0,
            uy = 0,
            deltaT = 0,
            gx = 0,
            gy = 0
          ) {
            this.pos = new Coordinate(x, y);
            this.rad = rad;
            this.face = face;
            this.lowersemi = new Semicircle(rad, mouth, false);
            this.uppersemi = new Semicircle(rad, -mouth, true);
            this.ux = ux;
            this.uy = uy;
            this.deltaT = deltaT;
            this.gx = gx;
            this.gy = gy;
            this.speed = speed;
          }
          render() {
            ctx.save();
            ctx.translate(this.pos.x, this.pos.y);
            ctx.rotate(this.face);
            this.lowersemi.render();
            this.uppersemi.render();
            ctx.restore();
          }
          update() {
            // using equation of motion
            // let delx =
            //   this.ux * this.deltaT + 0.5 * this.gx * this.deltaT * this.deltaT;
            // let dely =
            //   this.uy * this.deltaT + 0.5 * this.gy * this.deltaT * this.deltaT;

            // using rotation rate
            let delx = this.gx;
            let dely = this.gy;

            this.pos.x += delx;
            this.pos.y += dely;
            this.face = Math.atan2(dely, delx);

            if (this.pos.x > canvas.width - this.rad) {
              this.pos.x = canvas.width - this.rad;
              this.ux = 0;
            }
            if (this.pos.x < this.rad) {
              this.pos.x = this.rad;
              this.ux = 0;
            }
            if (this.pos.y > canvas.height - this.rad) {
              this.pos.y = canvas.height - this.rad;
              this.uy = 0;
            }
            if (this.pos.y < this.rad) {
              this.pos.y = this.rad;
              this.uy = 0;
            }
          }
          prefill(deltaT, gx, gy) {
            this.deltaT = deltaT;
            // this.ux = this.ux + this.gx * this.deltaT;
            // this.uy = this.uy + this.gy * this.deltaT;
            this.gx = -gx * this.speed;
            this.gy = gy * this.speed;
          }
        }

        let pacman = new Pacman(
          (canvas.width + 1) / 2,
          (canvas.height + 1) / 2,
          25,
          (35 * Math.PI) / 180,
          5
        );

        function update() {
          pacman.update();
        }

        function render() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          pacman.render();
        }

        function prefill(deltaT, gx, gy) {
          pacman.prefill(deltaT, gx, gy);
        }

        if (window.DeviceMotionEvent) {
          render();
          window.addEventListener(
            'devicemotion',
            (e) => {
              update();
              render();
              prefill(
                e.interval / 1000,
                e.accelerationIncludingGravity.x,
                e.accelerationIncludingGravity.y
              );
            },
            true
          );
        } else {
          console.log('Device not supported!');
          return;
        }
      }
    </script>
    <style type="text/css">
      html,
      body {
        margin: 0;
        height: 100%;
      }
      #game {
        display: block;
      }
    </style>
  </head>
  <body onload="draw();">
    <canvas id="game"></canvas>
  </body>
</html>
